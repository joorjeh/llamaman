#!/bin/bash

if [ ! -d "$HOME/.llamaman" ]; then
  mkdir "$HOME/.llamaman"
fi

if [ ! -f "$HOME/.llamaman/config.toml" ]; then
  cat <<EOF >"$HOME/.llamaman/config.toml"
platform = "ollama"
url = "http://localhost:11434/api/generate"
model = "llama3.1"
temperature = 0.0
max_steps = 10
top_p = 0.9
EOF
fi

if [ ! -f "$HOME/.llamaman/tools.json" ]; then
  cat <<EOF >"$HOME/.llamaman/tools.json"
{
  "read_file": {
    "description": "Read the contents of a file.",
    "parameters": {
      "filename": {
        "param_type": "string",
        "description": "The name of the file to read",
        "required": true
      }
    }
  },
  "write_file": {
    "description": "Write content to a file.",
    "parameters": {
      "filename": {
        "param_type": "string",
        "description": "The name of the file to write",
        "required": true
      },
      "content": {
        "param_type": "string",
        "description": "The content to write to the file",
        "required": true
      }
    }
  }
}
EOF
fi

if [ ! -f "$HOME/.llamaman/tools.rs" ]; then
  cat <<EOF >"$HOME/.llamaman/tools.rs"
use std::fs::File;
use std::fs::OpenOptions;
use std::io::Write;
use std::io::Read;
use std::path::PathBuf;

#[command]
fn read_file(filename: &str) -> Result<String, String> {
    let mut path = PathBuf::new();
    path.push(dirs::home_dir().ok_or_else(|| "Unable to get home directory".to_string())?);
    path.push(".llamaman");
    path.push(filename);

    let mut file = File::open(path).map_err(|err| err.to_string())?;
    let mut contents = String::new();
    file.read_to_string(&mut contents).map_err(|err| err.to_string())?;
    Ok(contents)
}

#[command]
fn write_file(filename: &str, content: &str) -> Result<String, String> {
    let mut path = PathBuf::new();
    path.push(dirs::home_dir().ok_or_else(|| "Unable to get home directory".to_string())?);
    path.push(".llamaman");
    path.push(filename);
    
    let mut file = OpenOptions::new()
        .write(true)
        .create(true)
        .truncate(true)
        .open(path)
        .map_err(|e| e.to_string())?;
    
    file.write_all(content.as_bytes())
        .map_err(|e| e.to_string())?;
    
    Ok(format!("Contents were written to file {}.", filename))
}
EOF
fi

# Check and install Node.js
if ! command -v node &>/dev/null && command -v npm &>/dev/null; then
  echo "node.js not found. Installing..."
  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
  nvm install 22

  # Check if node and npm were correctly installed
  if command -v node &>/dev/null && command -v npm &>/dev/null; then
    npm install -g yarn
    if ! command -v yarn &>/dev/null; then
      echo "yarn not installed successfully"
      exit 1
    else
      echo "yarn installed successfully"
    fi
    echo "node.js and npm have been successfully installed"
  else
    echo "Error: Node.js and npm installation failed"
    exit 1
  fi
else
  echo "Node.js is already installed"
  if ! command -v yarn &>/dev/null; then
    npm install -g yarn
  else
    echo "yarn already installed"
  fi
fi

# Check and install Rust
if ! command -v rustc &>/dev/null; then
  echo "Rust not found. Installing..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  source $HOME/.cargo/env
else
  echo "Rust is already installed."
fi

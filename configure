#!/bin/bash

if [ ! -d "$HOME/.llamaman" ]; then
  mkdir "$HOME/.llamaman"
fi

if [ ! -f "$HOME/.llamaman/config.toml" ]; then
  cat <<EOF >"$HOME/.llamaman/config.toml"
platform = "ollama"
url = "http://localhost:11434/api/generate"
model = "llama3.1"
EOF
fi

if [ ! -f "$HOME/.llamaman/tools.json" ]; then
  cat <<EOF >"$HOME/.llamaman/tools.json"
{
  "add": {
    "description": "Add two numbers together.",
    "parameters": {
      "a": {
        "param_type": "number",
        "description": "The first number to add",
        "required": true
      },
      "b": {
        "param_type": "number",
        "description": "The second number to add",
        "required": true
      }
    }
  }
}
EOF
fi

if [ ! -f "$HOME/.llamaman/tools.rs" ]; then
  cat <<EOF >"$HOME/.llamaman/tools.rs"
#[command]
fn add(a: i64, b: i64) -> i64 {
    return a + b;
}
EOF
fi

# Check and install Node.js
if ! command -v node &>/dev/null && command -v npm &>/dev/null; then
  echo "node.js not found. Installing..."
  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
  nvm install 22

  # Check if node and npm were correctly installed
  if command -v node &>/dev/null && command -v npm &>/dev/null; then
    npm install -g yarn
    if ! command -v yarn &>/dev/null; then
      echo "yarn not installed successfully"
      exit 1
    else
      echo "yarn installed successfully"
    fi
    echo "node.js and npm have been successfully installed"
  else
    echo "Error: Node.js and npm installation failed"
    exit 1
  fi
else
  echo "Node.js is already installed"
  if ! command -v yarn &>/dev/null; then
    npm install -g yarn
  else
    echo "yarn already installed"
  fi
fi

# Check and install Rust
if ! command -v rustc &>/dev/null; then
  echo "Rust not found. Installing..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  source $HOME/.cargo/env
else
  echo "Rust is already installed."
fi
